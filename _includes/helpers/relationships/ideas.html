{%- assign record = include.record | default: page -%}
{%- assign record_layout = include.layout | default: record.layout -%}
{%- assign relationships_items = '' | split: '' -%}
{%- assign ids = '' | split: '' -%}

{%- if record_layout == 'update' and record.idea_number -%}
  {%- assign ids = ids | push: record.idea_number -%}
{%- endif -%}
{%- if record.related_ideas -%}
  {%- assign ids = ids | concat: record.related_ideas -%}
{%- endif -%}

{%- comment -%} Bidirectional: Check if other records reference this record as an idea {%- endcomment -%}
{%- if record_layout == 'story' and record.related_ideas -%}
  {%- assign ids = ids | concat: record.related_ideas -%}
{%- endif -%}
{%- if record_layout == 'sprint' and record.related_ideas -%}
  {%- assign ids = ids | concat: record.related_ideas -%}
{%- endif -%}
{%- if record_layout == 'post' -%}
  {%- assign current_slug = record.slug | default: record.filename | replace: '.md', '' -%}
  {%- for idea in site.ideas -%}
    {%- if idea.related_materials and idea.related_materials contains current_slug -%}
      {%- assign ids = ids | push: idea.idea_number -%}
    {%- endif -%}
  {%- endfor -%}
  {%- for story in site.stories -%}
    {%- if story.related_materials and story.related_materials contains current_slug -%}
      {%- for idea_id in story.related_ideas -%}
        {%- assign ids = ids | push: idea_id -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endfor -%}
  {%- for sprint in site.sprints -%}
    {%- if sprint.related_materials and sprint.related_materials contains current_slug -%}
      {%- if sprint.related_ideas -%}
        {%- assign ids = ids | concat: sprint.related_ideas -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- for figure in site.figures -%}
    {%- if figure.related_materials and figure.related_materials contains current_slug -%}
      {%- if figure.related_ideas -%}
        {%- assign ids = ids | concat: figure.related_ideas -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- for update in site.updates -%}
    {%- if update.related_materials and update.related_materials contains current_slug -%}
      {%- assign ids = ids | push: update.idea_number -%}
      {%- if update.related_ideas -%}
        {%- assign ids = ids | concat: update.related_ideas -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- if record_layout == 'figure' and record.related_ideas -%}
  {%- assign ids = ids | concat: record.related_ideas -%}
{%- endif -%}

{%- assign ids = ids | uniq -%}

{%- for idea_id in ids -%}
  {%- assign idea_number = idea_id | plus: 0 -%}
  {%- assign idea_hit = site.ideas | where: "idea_number", idea_number | first -%}
  {%- if idea_hit -%}
    {%- assign relationships_items = relationships_items | push: idea_hit -%}
  {%- endif -%}
{%- endfor -%}


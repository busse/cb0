{%- assign record = include.record | default: page -%}
{%- assign record_layout = include.layout | default: record.layout -%}
{%- assign relationships_items = '' | split: '' -%}
{%- assign ids = '' | split: '' -%}

{%- if record_layout == 'update' and record.sprint_id -%}
  {%- assign ids = ids | push: record.sprint_id -%}
{%- endif -%}
{%- if record.related_sprints -%}
  {%- assign ids = ids | concat: record.related_sprints -%}
{%- endif -%}

{%- comment -%} Bidirectional: For stories, also check if this story's related_sprints includes any sprints {%- endcomment -%}
{%- if record_layout == 'story' and record.related_sprints -%}
  {%- assign ids = ids | concat: record.related_sprints -%}
{%- endif -%}
{%- comment -%} Bidirectional: For notes, check sprints that reference this note {%- endcomment -%}
{%- if record_layout == 'post' -%}
  {%- assign current_slug = record.slug | default: record.filename | replace: '.md', '' -%}
  {%- for sprint in site.sprints -%}
    {%- if sprint.related_materials and sprint.related_materials contains current_slug -%}
      {%- assign ids = ids | push: sprint.sprint_id -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- comment -%} Bidirectional: For ideas, check sprints that reference this idea {%- endcomment -%}
{%- if record_layout == 'idea' and record.idea_number -%}
  {%- for sprint in site.sprints -%}
    {%- if sprint.related_ideas and sprint.related_ideas contains record.idea_number -%}
      {%- assign ids = ids | push: sprint.sprint_id -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- comment -%} Bidirectional: For figures, check sprints that reference this figure {%- endcomment -%}
{%- if record_layout == 'figure' and record.figure_number -%}
  {%- for sprint in site.sprints -%}
    {%- if sprint.related_figures and sprint.related_figures contains record.figure_number -%}
      {%- assign ids = ids | push: sprint.sprint_id -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- comment -%} Bidirectional: For updates, check sprints that reference this update {%- endcomment -%}
{%- if record_layout == 'update' and record.notation -%}
  {%- for sprint in site.sprints -%}
    {%- if sprint.related_updates and sprint.related_updates contains record.notation -%}
      {%- assign ids = ids | push: sprint.sprint_id -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- assign ids = ids | uniq -%}

{%- for sprint_id in ids -%}
  {%- assign sprint_hit = site.sprints | where: "sprint_id", sprint_id | first -%}
  {%- if sprint_hit -%}
    {%- assign relationships_items = relationships_items | push: sprint_hit -%}
  {%- endif -%}
{%- endfor -%}

